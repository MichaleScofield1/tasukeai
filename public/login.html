<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ­ã‚°ã‚¤ãƒ³ - åŠ©ã‘åˆã„ã®æ¥µã¿</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      font-size: 32px;
      color: #2563eb;
      margin-bottom: 8px;
      text-align: center;
    }
    .subtitle {
      color: #6b7280;
      text-align: center;
      margin-bottom: 32px;
    }
    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border 0.3s;
    }
    input:focus, select:focus { border-color: #2563eb; }
    button {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .toggle-link { text-align: center; margin-top: 24px; }
    .toggle-link a {
      color: #2563eb;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
    }
    .register-fields { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>åŠ©ã‘åˆã„ã®æ¥µã¿</h1>
    <p class="subtitle" id="subtitle">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³</p>

    <div id="message"></div>

    <form id="authForm">
      <div class="form-group">
        <label>å­¦ç±ç•ªå·</label>
        <input type="text" id="studentId" required placeholder="12345678">
      </div>

      <div class="form-group">
        <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>

      <div class="register-fields" id="registerFields">

        <div class="form-group">
          <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span style="color: #dc2626;">*</span></label>
          <input type="email" id="email" placeholder="xxxxxxx@ed.tus.ac.jp">
        </div>

        <div class="form-group">
          <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  <span style="color: #dc2626;">*</span></label>
          <input type="text" id="nickname" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
        </div>

        <div class="form-group">
          <label>å­¦ç§‘</label>
          <select id="department">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="æƒ…å ±è¨ˆç®—ç§‘å­¦ç§‘">æƒ…å ±è¨ˆç®—ç§‘å­¦ç§‘</option>
            <option value="æ•°ç†ç§‘å­¦ç§‘">æ•°ç†ç§‘å­¦ç§‘</option>
            <option value="å…ˆç«¯ç‰©ç†å­¦ç§‘">å…ˆç«¯ç‰©ç†å­¦ç§‘</option>
            <option value="ç”Ÿå‘½æƒ…å ±å­¦ç§‘">ç”Ÿå‘½æƒ…å ±å­¦ç§‘</option>
            <option value="å…ˆç«¯ç§‘å­¦ç§‘">å…ˆç«¯ç§‘å­¦ç§‘</option>
            <option value="é›»æ°—é›»å­æƒ…å ±å·¥å­¦ç§‘">é›»æ°—é›»å­æƒ…å ±å·¥å­¦ç§‘</option>
            <option value="çµŒå–¶ã‚·ã‚¹ãƒ†ãƒ å·¥å­¦ç§‘">çµŒå–¶ã‚·ã‚¹ãƒ†ãƒ å·¥å­¦ç§‘</option>
            <option value="æ©Ÿæ¢°èˆªç©ºå®‡å®™å·¥å­¦ç§‘">æ©Ÿæ¢°èˆªç©ºå®‡å®™å·¥å­¦ç§‘</option>
            <option value="ç¤¾ä¼šåŸºç›¤å·¥å­¦ç§‘">ç¤¾ä¼šåŸºç›¤å·¥å­¦ç§‘</option>
            <option value="å»ºç¯‰å­¦ç§‘">å»ºç¯‰å­¦ç§‘</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>å­¦å¹´</label>
          <select id="year">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="1å¹´">1å¹´</option>
            <option value="2å¹´">2å¹´</option>
            <option value="3å¹´">3å¹´</option>
            <option value="4å¹´">4å¹´</option>
            <option value="ä¿®å£«1å¹´">ä¿®å£«1å¹´</option>
            <option value="ä¿®å£«2å¹´">ä¿®å£«2å¹´</option>
          </select>
        </div>

      </div>

      <button type="submit" id="submitBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>

    <div class="toggle-link">
      <a id="toggleLink">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ã“ã¡ã‚‰</a>
    </div>
  </div>

  <script>
    let isLogin = true;

    const form = document.getElementById('authForm');
    const toggleLink = document.getElementById('toggleLink');
    const submitBtn = document.getElementById('submitBtn');
    const subtitle = document.getElementById('subtitle');
    const registerFields = document.getElementById('registerFields');
    const messageDiv = document.getElementById('message');

    // æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
    toggleLink.addEventListener('click', () => {
      isLogin = !isLogin;

      if (isLogin) {
        subtitle.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³';
        submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        toggleLink.textContent = 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯ã“ã¡ã‚‰';
        registerFields.style.display = 'none';
      } else {
        subtitle.textContent = 'æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ';
        submitBtn.textContent = 'æ–°è¦ç™»éŒ²';
        toggleLink.textContent = 'æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯ã“ã¡ã‚‰';
        registerFields.style.display = 'block';
      }

      messageDiv.innerHTML = '';
    });

    // æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      messageDiv.innerHTML = '';
      submitBtn.disabled = true;
      submitBtn.textContent = 'å‡¦ç†ä¸­...';

      const studentId = document.getElementById('studentId').value;
      const password = document.getElementById('password').value;

      try {
        const endpoint = isLogin ? '/api/login' : '/api/register';

        const body = isLogin
          ? { studentId, password }
          : {
              studentId,
              password,
              email: document.getElementById('email').value,
              nickname: document.getElementById('nickname').value,
              department: document.getElementById('department').value,
              year: document.getElementById('year').value
            };

        const response = await fetch(`http://localhost:5000${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (!response.ok) {
          messageDiv.innerHTML = `<div class="error">${data.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}</div>`;
          submitBtn.disabled = false;
          submitBtn.textContent = isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²';
          return;
        }

        // ğŸ”¹ æ–°è¦ç™»éŒ²ã®å ´åˆï¼ˆãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå¿…è¦ï¼‰
        if (!isLogin) {
          messageDiv.innerHTML = `
            <div class="success">
              ä»®ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼<br>
              å­¦å†…ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸèªè¨¼ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
            </div>
          `;
          submitBtn.disabled = false;
          submitBtn.textContent = 'æ–°è¦ç™»éŒ²';
          return; // â† ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’çµ¶å¯¾ã«å®Ÿè¡Œã—ãªã„
        }

        // ğŸ”¹ ãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆï¼ˆèªè¨¼æ¸ˆï¼‰
        const userProfile = { ...data.user, skills: [] };
        localStorage.setItem('userProfile', JSON.stringify(userProfile));
        localStorage.setItem('authToken', data.token);

        messageDiv.innerHTML = `<div class="success">ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>`;

        setTimeout(() => {
          window.location.href = '/';
        }, 1000);

      } catch (err) {
        console.error('ã‚¨ãƒ©ãƒ¼:', err);
        messageDiv.innerHTML = '<div class="error">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“</div>';
      }

      submitBtn.disabled = false;
      submitBtn.textContent = isLogin ? 'ãƒ­ã‚°ã‚¤ãƒ³' : 'æ–°è¦ç™»éŒ²';
    });
  </script>
</body>
</html>
